machine:
  python:
    version: 3.4.2
  node:
    version: 0.12.2
  environment:
    DJANGO_SETTINGS_MODULES: edwin.settings
    DJANGO_CONFIGURATION: Test
    DATABASE_URL: postgres://ubuntu:@127.0.0.1:5432/circle_test
  services:
    - docker

dependencies:
  pre:
    # Set up docker 1.5, instead of the default 1.4.
    - sudo service docker stop
    - sudo curl -L -o /usr/bin/docker 'http://s3-external-1.amazonaws.com/circle-downloads/docker-1.5.0-circleci'
    - sudo chmod 0755 /usr/bin/docker
    - sudo service docker start
    - docker version
    - docker info
  post:
    - python manage.py collectstatic --noinput

database:
  override:
    - python manage.py migrate

test:
  override:
    - python manage.py test
    - npm test

deployment:
  dev:
    owner: mythmon
    branch: circleci
    commands:
      - heroku plugins:install heroku-docker
      - heroku maintenance:on --app edwin-dev
      - heroku docker:release --app edwin-dev
      - heroku run --app edwin-dev python manage.py migrate
      - heroku maintenance:off --app edwin-dev
